<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Influencer Product Matcher | goodmoodfood</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v={{ range(1000,9999) | random }}">
</head>
<body>
    <div class="container">
        <header>
            <div class="brand-bar">
                <img src="{{ url_for('static', filename='images/gmf-logo.webp') }}" alt="goodmoodfood logo" class="brand-logo">
                <span class="brand-name">goodmoodfood</span>
                <a href="{{ url_for('logout') }}" class="logout-link">Abmelden</a>
            </div>
            <h1>Influencer Product Matcher</h1>
            <p class="subtitle">Verifiziere und optimiere Produkt-Zuweisungen basierend auf Kollaborationsdaten</p>
        </header>

        <!-- Stats Bar -->
        <div id="stats" class="stats-bar" style="display: none;">
            <div class="stat-item">
                <span class="stat-label">Kontakte</span>
                <span class="stat-value" id="stat-contacts">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Produkte</span>
                <span class="stat-value" id="stat-products">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Status</span>
                <span class="stat-value status-ready">Bereit</span>
            </div>
        </div>

        <!-- Main Navigation -->
        <nav class="main-nav">
            <button class="nav-btn active" data-tab="profiles" onclick="switchMainTab('profiles')">Profile</button>
            <button class="nav-btn" data-tab="products" onclick="switchMainTab('products')">Produkte</button>
            <button class="nav-btn" data-tab="matcher" onclick="switchMainTab('matcher')">Matcher</button>
            <button class="nav-btn" data-tab="settings" onclick="switchMainTab('settings')">
                Einstellungen <span class="status-dot" id="aiStatusDot"></span>
            </button>
        </nav>

        <!-- ==================== TAB: PROFILES (default) ==================== -->
        <div id="main-profiles" class="main-tab-content">
            <div class="split-layout">
                <!-- Left: Profile list -->
                <div class="split-sidebar">
                    <div class="card sidebar-card">
                        <h2>Influencer-Profile</h2>
                        <div class="search-box">
                            <input type="text" id="profileSearchInput" placeholder="Name suchen..." class="input-field" oninput="filterProfiles()" list="profileNamesList">
                        </div>
                        <datalist id="profileNamesList"></datalist>
                        <div class="tag-filter-box">
                            <select id="tagFilter" class="input-field tag-filter-select" onchange="filterProfiles()">
                                <option value="">Alle Tags</option>
                            </select>
                        </div>

                        <!-- Sortable column headers -->
                        <div class="list-header">
                            <span class="list-header-col list-header-name sort-col active" data-sort="name" onclick="sortProfiles('name')">Name</span>
                            <span class="list-header-col list-header-followers sort-col" data-sort="follower" onclick="sortProfiles('follower')">Follower</span>
                            <span class="list-header-col list-header-count sort-col" data-sort="products" onclick="sortProfiles('products')">Produkte</span>
                        </div>

                        <div id="profileList" class="profile-list">
                            <div class="loading">Profile werden geladen...</div>
                        </div>
                    </div>
                </div>

                <!-- Right: Profile detail -->
                <div class="split-main">
                    <div id="profileDetailPlaceholder" class="card placeholder-card">
                        <div class="no-data">Waehle ein Profil aus der Liste</div>
                    </div>

                    <section id="profileDetail" class="card detail-card" style="display: none;">
                        <div class="profile-header">
                            <div class="profile-avatar-wrapper">
                                <div class="profile-avatar" id="profileAvatar"></div>
                                <label class="photo-upload-btn" title="Foto hochladen">
                                    <input type="file" id="photoUploadInput" accept="image/jpeg,image/png,image/webp" style="display:none" onchange="uploadProfilePhoto()">
                                    +
                                </label>
                            </div>
                            <div class="profile-header-info">
                                <h2 id="profileDetailName"></h2>
                                <a id="profileInstagram" href="#" target="_blank" class="profile-instagram" style="display: none;"></a>
                                <a id="profileEmail" href="#" class="profile-email" style="display: none;"></a>
                                <span class="profile-follower-count" id="profileFollowerCount" style="display: none;"></span>
                                <span class="profile-product-count" id="profileDetailCount"></span>
                            </div>
                        </div>

                        <!-- Tags -->
                        <div id="profileTags" class="profile-tags-section" style="display: none;">
                            <div id="profileTagsList" class="tag-chips"></div>
                            <div class="tag-input-wrapper">
                                <input type="text" id="tagInput" class="input-field tag-input" placeholder="Tag hinzufuegen..." list="tagSuggestions">
                                <datalist id="tagSuggestions"></datalist>
                                <button class="btn btn-small btn-primary" onclick="addTagFromInput()">+</button>
                            </div>
                        </div>

                        <!-- Status & Prio Badges -->
                        <div id="profileStatusSection" class="profile-status-section" style="display: none;">
                            <div id="profileStatusBadges" class="profile-status-badges"></div>
                            <span id="profilePrioBadge" class="prio-badge" style="display: none;"></span>
                        </div>

                        <!-- Website Links -->
                        <div id="profileWebsiteLinks" class="profile-website-links" style="display: none;"></div>

                        <!-- CS Hinweis -->
                        <div id="profileCSHinweis" class="cs-hinweis-box" style="display: none;"></div>

                        <div class="form-group">
                            <label>Notizen</label>
                            <textarea id="profileNotes" class="input-field profile-notes" placeholder="Notizen zu diesem Influencer..." rows="3"></textarea>
                            <button class="btn btn-primary btn-small" onclick="saveProfileNotes()">Notizen speichern</button>
                            <span id="notionSyncHint" class="notion-sync-hint" style="display:none;"></span>
                        </div>

                        <!-- Produkt-Historie (collapsible) -->
                        <div id="profileProducts" class="profile-products collapsible-section" style="display: none;">
                            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                <span class="collapsible-arrow">&#9654;</span>
                                <h3>Produkt-Historie</h3>
                            </div>
                            <div class="collapsible-body" style="display: none;">
                                <div id="profileProductsList"></div>
                            </div>
                        </div>

                        <!-- KI-Analyse -->
                        <div id="profileAIAnalysis" class="profile-ai-section">
                            <button id="aiAnalysisBtn" class="btn btn-ai btn-ai-profile" onclick="generateProfileAnalysis()">KI-Analyse</button>
                            <div id="aiAnalysisResult" style="display: none;"></div>
                        </div>

                        <!-- Notion Data (hidden container for backwards compat) -->
                        <div id="profileNotionData" style="display: none;"></div>

                        <!-- Collab History (collapsible) -->
                        <div id="profileCollabHistory" class="collapsible-section" style="display: none;">
                            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                <span class="collapsible-arrow">&#9654;</span>
                                <h3>Kollaborations-Historie</h3>
                            </div>
                            <div class="collapsible-body" style="display: none;">
                                <div id="collabHistoryContent" class="collab-history-box"></div>
                            </div>
                        </div>

                        <!-- Email Draft (collapsible) -->
                        <div id="profileEmailDraft" class="collapsible-section" style="display: none;">
                            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                <span class="collapsible-arrow">&#9654;</span>
                                <h3>E-Mail-Entwurf</h3>
                            </div>
                            <div class="collapsible-body" style="display: none;">
                                <div id="emailDraftContent" class="email-draft-box"></div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </div>

        <!-- ==================== TAB: PRODUCTS ==================== -->
        <div id="main-products" class="main-tab-content" style="display: none;">
            <div class="split-layout">
                <!-- Left: Product list -->
                <div class="split-sidebar">
                    <div class="card sidebar-card">
                        <h2>Produkte</h2>
                        <p>Klicke auf ein Produkt, um die zugehoerigen Influencer zu sehen</p>
                        <div class="search-box">
                            <input type="text" id="productSearchInput" placeholder="Produkt suchen (auch mit Tippfehler)..." class="input-field" oninput="filterProductList()" list="productNamesList">
                        </div>
                        <datalist id="productNamesList"></datalist>

                        <div id="productList" class="product-list">
                            <div class="loading">Produkte werden geladen...</div>
                        </div>
                    </div>
                </div>

                <!-- Right: Product detail (influencer list) -->
                <div class="split-main">
                    <div id="productDetailPlaceholder" class="card placeholder-card">
                        <div class="no-data">Waehle ein Produkt aus der Liste</div>
                    </div>

                    <div id="productDetail" class="card detail-card" style="display: none;">
                        <h2 id="productDetailName"></h2>
                        <p id="productDetailCount" class="text-muted"></p>
                        <div id="productInfluencers" class="product-influencer-list"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== TAB: MATCHER ==================== -->
        <div id="main-matcher" class="main-tab-content" style="display: none;">

            <!-- Step 1: Upload Data (collapsed by default) -->
            <details class="card upload-details">
                <summary class="upload-summary">
                    Optional: Zusaetzliche Kollaborationsdaten hochladen
                </summary>
                <p class="upload-hint">CSV/Excel-Dateien mit bisherigen Influencer-Kollaborationen. Testdaten sind bereits geladen.</p>

                <div class="upload-zone" id="dropzone">
                    <input type="file" id="fileInput" multiple accept=".csv,.xlsx,.xls" style="display: none;">
                    <div class="upload-icon">+</div>
                    <p>Dateien hierher ziehen oder klicken</p>
                    <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">
                        Dateien auswaehlen
                    </button>
                </div>

                <div id="uploadStatus" class="status-message" style="display: none;"></div>
            </details>

            <!-- Step 2: Search Individual -->
            <section class="card">
                <h2>Influencer suchen</h2>
                <p>Finde die Kollaborationshistorie eines Influencers</p>

                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="z.B. Laura Malina Seiler" class="input-field" list="contactNamesList" value="Laura Malina Seiler">
                    <button class="btn btn-primary" onclick="searchInfluencer()">Suchen</button>
                </div>
                <datalist id="contactNamesList"></datalist>

                <div id="searchResults" class="results-box" style="display: none;"></div>
            </section>

            <!-- Step 3: Verify Assignments -->
            <section class="card">
                <h2>Produkt-Zuweisung pruefen</h2>

                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('single')">Einzelpruefung</button>
                    <button class="tab-btn" onclick="switchTab('batch')">Batch-Pruefung</button>
                </div>

                <!-- Single Verification -->
                <div id="tab-single" class="tab-content">
                    <div class="form-group">
                        <label>Influencer Name</label>
                        <input type="text" id="verifySingleName" class="input-field" placeholder="z.B. Laura Malina Seiler" list="contactNamesList" value="Laura Malina Seiler">
                    </div>
                    <div class="form-group">
                        <label>Zugewiesenes Produkt</label>
                        <input type="text" id="verifySingleProduct" class="input-field" placeholder="z.B. Rohkakao Peru (auch Tippfehler OK)" list="productNamesList" value="Rohkakao Peru">
                    </div>
                    <button class="btn btn-primary" onclick="verifySingle()">Zuweisung pruefen</button>

                    <div id="verifySingleResult" class="result-card" style="display: none;"></div>
                </div>

                <!-- Batch Verification -->
                <div id="tab-batch" class="tab-content" style="display: none;">
                    <p>Excel/CSV-Datei mit Spalten: Name, Product hochladen</p>

                    <input type="file" id="batchFile" accept=".csv,.xlsx,.xls" class="input-field">
                    <button class="btn btn-primary" onclick="verifyBatch()">Alle pruefen</button>

                    <div id="batchResults" style="display: none;">
                        <div class="batch-stats"></div>
                        <div class="batch-table-container">
                            <table id="resultsTable" class="results-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Zugewiesen</th>
                                        <th>Status</th>
                                        <th>Bisherige Produkte</th>
                                        <th>Score</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <button class="btn btn-secondary" onclick="exportResults()">Export Results</button>
                    </div>
                </div>
            </section>

        </div>

        <!-- ==================== TAB: SETTINGS ==================== -->
        <div id="main-settings" class="main-tab-content" style="display: none;">

            <!-- Non-admin hint (shown for team users) -->
            <div id="adminOnlyHint" class="card" style="display: none;">
                <p class="no-data">Fuer Aenderungen an Verbindungen und Passwort ist ein Admin-Zugang noetig.</p>
            </div>

            <div id="adminOnlySettings">
            <section class="card">
                <h2>KI-Verbindung</h2>
                <p>Verbinde eine KI fuer intelligente Match-Erklaerungen und Empfehlungen</p>

                <!-- Connection Status -->
                <div id="connectionStatus" class="connection-status">
                    <div class="loading">Status wird geladen...</div>
                </div>

                <!-- Primary: OpenRouter OAuth -->
                <div id="connectSection">
                    <button class="btn connect-btn" onclick="connectOpenRouter()">
                        Mit OpenRouter verbinden
                    </button>
                    <p class="connect-hint">Zugang zu GPT-4o, Claude, Gemini und 100+ Modellen ueber einen Account</p>
                </div>

                <!-- Disconnect -->
                <div id="disconnectSection" style="display: none;">
                    <button class="btn btn-danger" onclick="disconnectAI()">Verbindung trennen</button>
                </div>

                <!-- Fallback: Manual API Key -->
                <details class="fallback-section">
                    <summary>Oder manuell API-Key eingeben</summary>
                    <div class="fallback-content">
                        <div class="form-group">
                            <label>Provider</label>
                            <select id="manualProvider" class="input-field">
                                <option value="openrouter">OpenRouter</option>
                                <option value="openai">OpenAI</option>
                                <option value="anthropic">Anthropic (Claude)</option>
                                <option value="gemini">Google (Gemini)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>API-Key</label>
                            <input type="password" id="manualApiKey" class="input-field" placeholder="sk-...">
                        </div>
                        <button class="btn btn-primary" onclick="saveManualKey()">Testen & Speichern</button>
                        <div id="manualKeyStatus" style="display: none;"></div>
                    </div>
                </details>
            </section>

            <!-- Notion Connection -->
            <section class="card">
                <h2>Notion-Verbindung</h2>
                <p>Verbinde die Testimonials-Datenbank aus Notion fuer aktuelle Daten und E-Mail-Entwuerfe</p>

                <!-- Connection Status -->
                <div id="notionConnectionStatus" class="connection-status">
                    <div class="loading">Status wird geladen...</div>
                </div>

                <!-- Token Input (shown when disconnected) -->
                <div id="notionConnectSection">
                    <div class="form-group">
                        <label>Notion Integration Token</label>
                        <input type="password" id="notionToken" class="input-field" placeholder="ntn_...">
                        <p class="connect-hint">
                            Erstelle eine Integration unter
                            <a href="https://www.notion.so/my-integrations" target="_blank" style="color: var(--primary-light);">notion.so/my-integrations</a>
                            und teile die TM-Datenbank mit ihr.
                        </p>
                    </div>
                    <button class="btn btn-primary" onclick="saveNotionToken()">Testen & Speichern</button>
                    <div id="notionTokenStatus" style="display: none;"></div>
                </div>

                <!-- Connected state -->
                <div id="notionDisconnectSection" style="display: none;">
                    <button class="btn btn-primary" onclick="syncNotion()" id="notionSyncBtn">
                        Notion-Daten synchronisieren
                    </button>
                    <span id="notionSyncStatus" class="connect-hint"></span>
                    <br><br>
                    <button class="btn btn-danger" onclick="disconnectNotion()">Verbindung trennen</button>
                </div>
            </section>

            <!-- Password Change -->
            <section class="card">
                <h2>Passwort aendern</h2>
                <div class="form-group">
                    <label>Aktuelles Passwort</label>
                    <input type="password" id="oldPassword" class="input-field" placeholder="Aktuelles Passwort">
                </div>
                <div class="form-group">
                    <label>Neues Passwort</label>
                    <input type="password" id="newPassword" class="input-field" placeholder="Neues Passwort (min. 4 Zeichen)">
                </div>
                <button class="btn btn-primary" onclick="changePassword()">Passwort aendern</button>
                <div id="passwordChangeStatus" style="display: none;"></div>
            </section>
            </div><!-- /adminOnlySettings -->

        </div>

        <footer>
            <p><span class="brand-name-small">goodmoodfood</span> â€” From Source to Soul</p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="{{ url_for('static', filename='js/app2.js') }}?v={{ range(1000,9999) | random }}"></script>
</body>
</html>
